<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaRich User Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” & ì• ë‹ˆë©”ì´ì…˜ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // ----------------------------------------------------------------------
        // [System Core] ì•„ì´ì½˜ ì‹œìŠ¤í…œ
        // ----------------------------------------------------------------------
        
        const createIcon = (symbol) => ({ className, size, onClick }) => (
            <span className={className} onClick={onClick} style={{ 
                fontSize: size ? size + 'px' : '16px', 
                lineHeight: 1, 
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontStyle: 'normal',
                cursor: 'pointer'
            }}>{symbol}</span>
        );

        const Icons = {
            User: createIcon("ğŸ‘¤"),
            Lock: createIcon("ğŸ”’"),
            Phone: createIcon("ğŸ“"),
            Calendar: createIcon("ğŸ“…"),
            ClipboardList: createIcon("ğŸ“‹"),
            ArrowLeft: createIcon("â†"),
            CheckCircle2: createIcon("âœ…"),
            AlertCircle: createIcon("â—"),
            LogOut: createIcon("ğŸšª"),
            Bell: createIcon("ğŸ””"),
            FileText: createIcon("ğŸ“„"),
            Clock: createIcon("ğŸ•’"),
            CreditCard: createIcon("ğŸ’³"),
            LayoutDashboard: createIcon("ğŸ "),
            Database: createIcon("ğŸ—ƒï¸"),
            Send: createIcon("ğŸ“¤"),
            RotateCcw: createIcon("â†©ï¸"),
            Search: createIcon("ğŸ”"),
            Filter: createIcon("ğŸŒªï¸"),
            MoreVertical: createIcon("â‹®"),
            ChevronRight: createIcon("â€º"),
            ChevronLeft: createIcon("â€¹"),
            ChevronDown: createIcon("âŒ„"), // [ìˆ˜ì •] ëˆ„ë½ëœ ì•„ì´ì½˜ ì¶”ê°€
            MessageSquare: createIcon("ğŸ’¬"),
            Plus: createIcon("â•"),
            Save: createIcon("ğŸ’¾"),
            ExternalLink: createIcon("ğŸ”—"),
            RefreshCw: createIcon("ğŸ”„"),
            X: createIcon("âœ•"),
            KeyRound: createIcon("ğŸ”‘"),
            UserPlus: createIcon("â•ğŸ‘¤"),
            HelpCircle: createIcon("â“"),
            Receipt: createIcon("ğŸ§¾"),
            Wallet: createIcon("ğŸ‘›"),
            Users2: createIcon("ğŸ‘¥"),
            Settings: createIcon("âš™ï¸")
        };

        const { 
            User, Lock, Phone, Calendar, ClipboardList, ArrowLeft, CheckCircle2, AlertCircle,
            LogOut, Bell, FileText, Clock, CreditCard, LayoutDashboard, Database, Send, 
            RotateCcw, Search, Filter, MoreVertical, ChevronRight, ChevronLeft, ChevronDown, // [ìˆ˜ì •] ëˆ„ë½ëœ ì•„ì´ì½˜ ì¶”ê°€
            MessageSquare, Plus, Save, ExternalLink, RefreshCw, X, KeyRound, UserPlus, HelpCircle, Receipt, 
            Wallet, Users2, Settings
        } = Icons;

        const API_URL = ""; 

        // ----------------------------------------------------------------------
        // [View Components]
        // ----------------------------------------------------------------------

        // 1. ë¡œê·¸ì¸ ë·°
        const LoginView = ({ onLogin, loading }) => {
            const [id, setId] = React.useState('');
            const [pw, setPw] = React.useState('');

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') onLogin(id, pw);
            };

            return (
                <div className="flex-1 flex items-center justify-center p-6 min-h-screen fade-in">
                    <div className="w-full max-w-sm p-8 bg-white border border-slate-200 rounded-2xl shadow-xl text-center">
                        <div className="mb-8">
                            <h1 className="text-2xl font-black italic text-slate-900">METARICH</h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Partners Portal v5.96</p>
                        </div>
                        <div className="space-y-4 text-left">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase ml-1">ID (ì‚¬ë²ˆ)</label>
                                <input 
                                    className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold mt-1 outline-none focus:ring-2 focus:ring-blue-500 transition-colors" 
                                    placeholder="ì‚¬ë²ˆ ì…ë ¥" 
                                    value={id} 
                                    onChange={e=>setId(e.target.value)} 
                                    onKeyDown={handleKeyDown}
                                    autoFocus
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Password</label>
                                <input 
                                    className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold mt-1 outline-none focus:ring-2 focus:ring-blue-500 transition-colors" 
                                    type="password" 
                                    placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                                    value={pw} 
                                    onChange={e=>setPw(e.target.value)} 
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <button 
                                onClick={()=>onLogin(id, pw)} 
                                disabled={loading}
                                className="w-full py-4 bg-slate-900 text-white rounded-xl font-black mt-2 shadow-lg active:scale-[0.98] transition-all flex justify-center items-center gap-2"
                            >
                                {loading && <RefreshCw size={14} className="animate-spin"/>}
                                <span>{loading ? "ë¡œê·¸ì¸ ì¤‘..." : "ë¡œê·¸ì¸"}</span>
                            </button>
                        </div>
                        {!API_URL && (
                            <div className="mt-6 bg-blue-50 p-4 rounded-xl text-left border border-blue-100">
                                <p className="text-[10px] text-blue-500 font-black mb-2 uppercase flex items-center gap-1"><AlertCircle size={10}/> í…ŒìŠ¤íŠ¸ ê³„ì • ì•ˆë‚´</p>
                                <div className="space-y-1 text-xs font-bold text-slate-600">
                                    <p>â€¢ ì˜ì—…ì: <strong>test</strong> / <strong>test</strong></p>
                                    <p>â€¢ ì§€ì ì¥: <strong>manager</strong> / <strong>manager</strong></p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 2. ë©”ì¸ ëŒ€ì‹œë³´ë“œ
        const MainDashboard = ({ dbInventory, applyHistory }) => {
            return (
                <div className="space-y-6 fade-in">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-6 bg-white border border-slate-200 rounded-xl shadow-sm">
                            <p className="text-[10px] text-slate-400 font-black uppercase">ë‚˜ì˜ DB</p>
                            <div className="flex items-center justify-between mt-2">
                                <p className="text-3xl font-black text-blue-600">{dbInventory.length}</p>
                                <Database className="text-slate-200" size={32}/>
                            </div>
                        </div>
                        <div className="p-6 bg-white border border-slate-200 rounded-xl shadow-sm">
                            <p className="text-[10px] text-slate-400 font-black uppercase">ì‹ ì²­ ëŒ€ê¸°</p>
                            <div className="flex items-center justify-between mt-2">
                                <p className="text-3xl font-black text-slate-600">{applyHistory.length}</p> 
                                <Clock className="text-slate-200" size={32}/>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                        <h3 className="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
                            <Clock size={16} className="text-blue-600"/> ìµœê·¼ ë°°ì • ëª©ë¡
                        </h3>
                        <div className="divide-y divide-slate-50">
                            {dbInventory.length > 0 ? dbInventory.slice(0, 5).map(db => (
                                <div key={db.id} className="flex items-center justify-between py-4">
                                    <div>
                                        <span className="text-sm font-black text-slate-800 block">{db.customerName}</span>
                                        <span className="text-[10px] text-slate-400 font-mono">{db.date ? db.date.split('T')[0] : '-'} | {db.type}</span>
                                    </div>
                                    <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">{db.status}</span>
                                </div>
                            )) : (
                                <p className="text-center text-xs text-slate-300 py-10 font-bold italic">ë°°ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. DB ì‹ ì²­ (ì•ˆì „í•œ ì´ˆê¸°í™” ë¡œì§ ì ìš©)
        const DBApplyView = ({ onApply, loading, applyHistory, dbTypes }) => {
            const [form, setForm] = React.useState({ type: '', qty: 1 });
            const [selectedHistory, setSelectedHistory] = React.useState(null);
            
            // dbTypes ë¡œë“œ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
            React.useEffect(() => {
                if (dbTypes && dbTypes.length > 0 && !form.type) {
                    setForm(prev => ({ ...prev, type: dbTypes[0].name }));
                }
            }, [dbTypes]);

            // ì•ˆì „í•œ ë°ì´í„° ì°¸ì¡°
            const selectedDBInfo = React.useMemo(() => {
                if (!Array.isArray(dbTypes) || dbTypes.length === 0) return null;
                return dbTypes.find(d => d.name === form.type) || dbTypes[0];
            }, [dbTypes, form.type]);

            const totalPrice = React.useMemo(() => {
                if (!selectedDBInfo || typeof selectedDBInfo.price !== 'number') return "0";
                return (selectedDBInfo.price * form.qty).toLocaleString();
            }, [selectedDBInfo, form.qty]);

            const handleQtyChange = (e) => {
                const val = parseInt(e.target.value, 10);
                if (isNaN(val) || val < 1) {
                    setForm(prev => ({ ...prev, qty: 1 }));
                } else {
                    setForm(prev => ({ ...prev, qty: val }));
                }
            };

            const handleApply = () => {
                if (!selectedDBInfo) {
                    alert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                onApply({ 
                    ...form, 
                    pricePerUnit: selectedDBInfo.price, 
                    totalAmount: selectedDBInfo.price * form.qty 
                });
                alert('ì‹ ì²­ì´ ì™„ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };

            // ë°ì´í„° ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì—†ì„ ë•Œ ì²˜ë¦¬
            if (!selectedDBInfo) {
                return <div className="p-10 text-center text-slate-400">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>;
            }

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white border border-slate-200 rounded-xl p-8 shadow-sm">
                        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-50">
                            <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><Send size={20}/></div>
                            <div>
                                <h3 className="text-lg font-black text-slate-800">DB ì‹ ì²­</h3>
                                <p className="text-xs text-slate-400 font-bold">ì‹ ê·œ ê°€ë§ ê³ ê° ë°°ì • ìš”ì²­</p>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase">DB ì¢…ë¥˜</label>
                                <select 
                                    className="w-full p-3 border rounded-lg text-sm font-bold mt-1 bg-white outline-none focus:ring-2 focus:ring-blue-500" 
                                    value={form.type} 
                                    onChange={e=>setForm({...form, type:e.target.value})}
                                >
                                    {dbTypes.map(type => <option key={type.code} value={type.name}>{type.name}</option>)}
                                </select>
                                
                                <div className="mt-3 p-4 bg-slate-50 rounded-lg border border-slate-100">
                                    <div className="flex justify-between items-center text-xs mb-2">
                                        <span className="text-slate-500 font-bold">ë‹¨ê°€</span>
                                        <span className="font-black text-slate-800 text-sm">{(selectedDBInfo.price).toLocaleString()}ì›</span>
                                    </div>
                                    <div className="flex justify-between items-center text-xs">
                                        <span className="text-slate-500 font-bold">í”„ë¡œëª¨ì…˜</span>
                                        <span className="font-black text-blue-600 text-right max-w-[200px] truncate">{selectedDBInfo.promotion || '-'}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase">ìˆ˜ëŸ‰</label>
                                <input 
                                    type="number" 
                                    min="1" 
                                    className="w-full p-3 border rounded-lg text-sm font-bold mt-1 outline-none focus:ring-2 focus:ring-blue-500" 
                                    value={form.qty} 
                                    onChange={handleQtyChange}
                                />
                            </div>
                            <div className="pt-4 border-t border-slate-100 flex justify-between items-center">
                                <span className="text-xs font-black text-slate-500">ì´ ì˜ˆìƒ ê¸ˆì•¡</span>
                                <span className="text-xl font-black text-rose-500">{totalPrice}ì›</span>
                            </div>
                            <button 
                                onClick={handleApply} 
                                disabled={loading} 
                                className="w-full py-4 bg-slate-900 text-white rounded-lg font-black text-sm mt-4 shadow-lg hover:bg-black transition-all"
                            >
                                {loading ? "ì²˜ë¦¬ ì¤‘..." : "ì‹ ì²­í•˜ê¸°"}
                            </button>
                        </div>
                    </div>

                    {/* ì‹ ì²­ ë‚´ì—­ ë¡œê·¸ */}
                    <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <div className="p-4 border-b bg-slate-50 font-black text-xs text-slate-500 uppercase flex justify-between items-center">
                            <span>ìµœê·¼ ì‹ ì²­ ë‚´ì—­</span>
                            <span className="text-[10px] text-slate-400">Click for details</span>
                        </div>
                        <div className="divide-y text-slate-700 max-h-60 overflow-y-auto">
                            {applyHistory.map((log, i) => (
                                <div key={i} className="p-4 flex justify-between items-center text-sm cursor-pointer hover:bg-slate-50 transition-colors" onClick={() => setSelectedHistory(log)}>
                                    <div>
                                        <span className="font-bold text-slate-700 block">{log.type} {log.qty}ê°œ</span>
                                        <span className="text-[10px] text-slate-400 font-mono">{log.date}</span>
                                    </div>
                                    <span className={`text-[10px] px-2 py-1 rounded font-bold ${log.paymentStatus === 'ê²°ì œì™„ë£Œ' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-500'}`}>
                                        {log.paymentStatus || 'ê²°ì œì „'}
                                    </span>
                                </div>
                            ))}
                            {applyHistory.length === 0 && <div className="p-8 text-center text-xs text-slate-300 italic">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* ì‹ ì²­ ë‚´ì—­ ìƒì„¸ ëª¨ë‹¬ */}
                    {selectedHistory && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6">
                                <h3 className="font-black text-lg mb-4 flex justify-between items-center">
                                    ì‹ ì²­ ìƒì„¸ ì •ë³´
                                    <button onClick={() => setSelectedHistory(null)}><X size={20} className="text-slate-400"/></button>
                                </h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">DB ì¢…ë¥˜</span> <span className="font-bold">{selectedHistory.type}</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ìˆ˜ëŸ‰</span> <span className="font-bold">{selectedHistory.qty}ê°œ</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ì´ ê¸ˆì•¡</span> <span className="font-bold text-blue-600">{(selectedHistory.totalAmount || 0).toLocaleString()}ì›</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ê²°ì œëœ ê¸ˆì•¡</span> <span className="font-bold text-emerald-600">{(selectedHistory.paidAmount || 0).toLocaleString()}ì›</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ê²°ì œ ë°©ë²•</span> <span className="font-bold">{selectedHistory.method || 'ë¯¸ì§€ì •'}</span></div>
                                    <div className="flex justify-between items-center pt-1"><span className="text-slate-500 font-bold">ìƒíƒœ</span> <span className={`px-2 py-0.5 rounded text-xs font-bold text-white ${selectedHistory.paymentStatus==='ê²°ì œì™„ë£Œ'?'bg-emerald-500':'bg-rose-500'}`}>{selectedHistory.paymentStatus || 'ê²°ì œì „'}</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. DB ê´€ë¦¬ (ë‹¤ì´ë‚˜ë¯¹ ëª©ë¡ ì˜¤ë¥˜ ìˆ˜ì • - ì•ˆì „í•œ ë°°ì—´ ìƒì„±)
        const DBManageView = ({ dbInventory, applyHistory, onSaveMemo, onUpdateStatus, dbTypes }) => {
            const [filterType, setFilterType] = React.useState('ì „ì²´');
            const [search, setSearch] = React.useState({ name: '', phone: '', date: '', status: '' });
            const [selectedDB, setSelectedDB] = React.useState(null);
            const [memo, setMemo] = React.useState('');

            // [í†µê³„] ë°°ì •ëœ ìˆ˜ëŸ‰
            const assignStats = React.useMemo(() => {
                const stats = {};
                if(Array.isArray(dbInventory)) {
                    dbInventory.forEach(d => { stats[d.type] = (stats[d.type] || 0) + 1; });
                }
                return stats;
            }, [dbInventory]);

            // [í†µê³„] ì‹ ì²­í•œ ìˆ˜ëŸ‰
            const requestStats = React.useMemo(() => {
                const stats = {};
                if(Array.isArray(applyHistory)) {
                    applyHistory.forEach(a => { stats[a.type] = (stats[a.type] || 0) + parseInt(a.qty || 0); });
                }
                return stats;
            }, [applyHistory]);

            const totalAssigned = Array.isArray(dbInventory) ? dbInventory.length : 0;
            const totalRequested = Array.isArray(applyHistory) ? applyHistory.reduce((acc, cur) => acc + parseInt(cur.qty || 0), 0) : 0;

            // [ì•ˆì „í•œ ëª©ë¡ ìƒì„±] dbTypesê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
            const allTypes = React.useMemo(() => {
                const typesFromDB = Array.isArray(dbTypes) ? dbTypes.map(t => t.name) : [];
                const typesFromAssign = Object.keys(assignStats);
                const typesFromRequest = Object.keys(requestStats);
                return [...new Set([...typesFromDB, ...typesFromAssign, ...typesFromRequest])];
            }, [dbTypes, assignStats, requestStats]);

            const filteredDBs = (dbInventory || []).filter(d => {
                const matchesType = filterType === 'ì „ì²´' || d.type === filterType;
                const matchesName = !search.name || d.customerName.includes(search.name);
                const matchesPhone = !search.phone || (d.phone && d.phone.includes(search.phone));
                const matchesDate = !search.date || (d.date && d.date.includes(search.date));
                const matchesStatus = !search.status || d.status.includes(search.status);
                return matchesType && matchesName && matchesPhone && matchesDate && matchesStatus;
            });

            const openDetail = (db) => {
                setSelectedDB(db);
                setMemo('');
            };

            const saveLog = () => {
                if(!memo.trim()) return;
                const timestamp = new Date().toLocaleString();
                const newEntry = `[${timestamp}] ${memo}`;
                const updatedMemo = selectedDB.memos ? `${selectedDB.memos}\n${newEntry}` : newEntry;
                onSaveMemo(selectedDB.id, updatedMemo);
                setSelectedDB({...selectedDB, memos: updatedMemo});
                setMemo('');
            };

            const changeStatus = (e) => {
                const newStatus = e.target.value;
                onUpdateStatus(selectedDB.id, newStatus);
                setSelectedDB({...selectedDB, status: newStatus});
            };

            return (
                <div className="space-y-4 fade-in">
                    {/* [í˜„í™© ìš”ì•½ ë° ë‹¤ì´ë‚˜ë¯¹ ëª©ë¡] */}
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-black text-slate-800 text-sm flex items-center gap-2">
                                <Database size={16} className="text-blue-600"/> DB í˜„í™© ìš”ì•½
                            </h3>
                            <div className="text-xs font-bold bg-slate-100 px-3 py-1 rounded-full text-slate-600">
                                <span className="text-blue-600">ë°°ì • {totalAssigned}</span> <span className="text-slate-300">/</span> <span>ì‹ ì²­ {totalRequested}</span>
                            </div>
                        </div>
                        
                        {/* ë‹¤ì´ë‚˜ë¯¹ ë“œë¡­ë‹¤ìš´ */}
                        <div className="relative">
                            <select 
                                className="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 appearance-none cursor-pointer"
                                value={filterType}
                                onChange={(e) => setFilterType(e.target.value)}
                            >
                                <option value="ì „ì²´">ì „ì²´ ë³´ê¸° (ë°°ì • {totalAssigned} / ì‹ ì²­ {totalRequested})</option>
                                {allTypes.map(type => (
                                    <option key={type} value={type}>
                                        {type} (ë°°ì • {assignStats[type] || 0} / ì‹ ì²­ {requestStats[type] || 0})
                                    </option>
                                ))}
                            </select>
                            <ChevronDown className="absolute right-3 top-3.5 text-slate-400 pointer-events-none" size={16}/>
                        </div>
                    </div>

                    {/* ìƒì„¸ ê²€ìƒ‰ í•„í„° */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-black text-slate-500 flex items-center gap-1"><Search size={12}/> ìƒì„¸ ê²€ìƒ‰</span>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <input className="p-2 border rounded text-xs outline-none" placeholder="ì´ë¦„" value={search.name} onChange={e=>setSearch({...search, name:e.target.value})} />
                            <input className="p-2 border rounded text-xs outline-none" placeholder="ì—°ë½ì²˜" value={search.phone} onChange={e=>setSearch({...search, phone:e.target.value})} />
                            <input className="p-2 border rounded text-xs outline-none" type="date" value={search.date} onChange={e=>setSearch({...search, date:e.target.value})} />
                            <input className="p-2 border rounded text-xs outline-none" placeholder="ìƒíƒœ" value={search.status} onChange={e=>setSearch({...search, status:e.target.value})} />
                        </div>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 text-slate-500 border-b">
                                <tr>
                                    <th className="p-4">ë‚ ì§œ</th>
                                    <th className="p-4">ê³ ê°ëª…</th>
                                    <th className="p-4">ì¢…ë¥˜</th>
                                    <th className="p-4 text-center">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y text-slate-700">
                                {filteredDBs.map(db => (
                                    <tr key={db.id} className="hover:bg-slate-50 cursor-pointer" onClick={()=>openDetail(db)}>
                                        <td className="p-4 font-mono text-slate-400">{db.date ? db.date.split('T')[0] : '-'}</td>
                                        <td className="p-4 text-slate-800">{db.customerName}</td>
                                        <td className="p-4 text-slate-500">{db.type}</td>
                                        <td className="p-4 text-center"><span className="px-2 py-1 bg-slate-100 rounded text-[10px]">{db.status}</span></td>
                                    </tr>
                                ))}
                                {filteredDBs.length === 0 && <tr><td colSpan="4" className="p-10 text-center text-slate-300 italic">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {/* ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ */}
                    {selectedDB && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="bg-slate-50 p-4 border-b flex justify-between items-center shrink-0">
                                    <h3 className="font-black text-slate-800 flex items-center gap-2"><User size={16}/> ê³ ê° ìƒì„¸ ì •ë³´</h3>
                                    <button onClick={()=>setSelectedDB(null)}><X size={20} className="text-slate-400 hover:text-rose-500"/></button>
                                </div>
                                <div className="p-6 space-y-4 overflow-y-auto">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="bg-blue-50 p-2 rounded border border-blue-100">
                                            <p className="text-[10px] text-blue-400 font-bold uppercase">DB Code</p>
                                            <p className="text-sm font-mono font-black text-blue-700">{selectedDB.id}</p>
                                        </div>
                                        <div className="w-1/2">
                                            <p className="text-[10px] text-slate-400 font-bold mb-1">ì§„í–‰ ìƒíƒœ ë³€ê²½</p>
                                            <select className="w-full p-2 border rounded text-xs font-bold outline-none bg-slate-50 focus:bg-white focus:border-blue-500" value={selectedDB.status} onChange={changeStatus}>
                                                <option>ë¯¸ì‹œë„</option>
                                                <option>ì—°ë½ì „</option>
                                                <option>ë¶€ì¬</option>
                                                <option>ê±°ì ˆ</option>
                                                <option>ë¯¸íŒ… í™•ì •</option>
                                                <option>ì·¨ì†Œ</option>
                                                <option>ì—°ê¸°</option>
                                                <option>ì™„ë£Œ</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div><p className="text-[10px] text-slate-400 font-black">ì´ë¦„</p><p className="font-bold">{selectedDB.customerName}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ì—°ë½ì²˜</p><p className="font-bold">{selectedDB.phone || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ìƒë…„ì›”ì¼</p><p className="font-bold">{selectedDB.dob || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ì„±ë³„</p><p className="font-bold">{selectedDB.gender || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ì§€ì—­</p><p className="font-bold">{selectedDB.area || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ê¸°íƒ€1</p><p className="font-bold">{selectedDB.etc1 || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ê¸°íƒ€2</p><p className="font-bold">{selectedDB.etc2 || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ê¸°íƒ€3</p><p className="font-bold">{selectedDB.etc3 || '-'}</p></div>
                                        <div><p className="text-[10px] text-slate-400 font-black">ê¸°íƒ€4</p><p className="font-bold">{selectedDB.etc4 || '-'}</p></div>
                                    </div>
                                    <div className="pt-4 border-t">
                                        <p className="text-[10px] text-slate-400 font-black mb-2">ë©”ëª¨ ë¡œê·¸</p>
                                        <div className="bg-slate-50 p-3 rounded-lg text-xs text-slate-600 h-32 overflow-y-auto whitespace-pre-wrap mb-2 border border-slate-100 flex flex-col-reverse">
                                            {selectedDB.memos || "ê¸°ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}
                                        </div>
                                        <div className="flex gap-2">
                                            <input className="flex-1 p-2 border rounded-lg text-xs outline-none focus:border-blue-500" placeholder="ìƒˆë¡œìš´ ë©”ëª¨ ì…ë ¥..." value={memo} onChange={e=>setMemo(e.target.value)} />
                                            <button onClick={saveLog} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-black hover:bg-blue-700">ì €ì¥</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. íŒ€ DB ê´€ë¦¬
        const TeamManageView = ({ teamDBs }) => {
            const [filterType, setFilterType] = React.useState('ì „ì²´');
            const [filterMember, setFilterMember] = React.useState('ì „ì²´');
            const [search, setSearch] = React.useState({ name: '', phone: '', status: '' });
            const [selectedDB, setSelectedDB] = React.useState(null);

            const teamMembers = [...new Set(teamDBs.map(d => d.partnerName))];

            const filteredDBs = teamDBs.filter(d => 
                (filterType === 'ì „ì²´' || d.type === filterType) &&
                (filterMember === 'ì „ì²´' || d.partnerName === filterMember) &&
                (!search.name || d.customerName.includes(search.name)) &&
                (!search.phone || (d.phone && d.phone.includes(search.phone))) &&
                (!search.status || d.status.includes(search.status))
            );

            return (
                <div className="space-y-4 fade-in">
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                        <div className="flex items-center gap-2 text-sm font-black text-slate-800 border-b pb-2">
                            <Users2 size={18} className="text-emerald-600"/> 
                            <span>íŒ€ì› DB í˜„í™©</span>
                        </div>
                        <div className="flex gap-2">
                            <select className="flex-1 p-2 border rounded-lg text-xs font-bold outline-none" value={filterType} onChange={e=>setFilterType(e.target.value)}>
                                <option value="ì „ì²´">ì „ì²´ ì¢…ë¥˜</option>
                                <option>ë³´ì¥ë¶„ì„</option>
                                <option>ìš´ì „ìë³´í—˜</option>
                                <option>ì¬ê°€ë³´í—˜</option>
                                <option>í«ë³´í—˜</option>
                            </select>
                            <select className="flex-1 p-2 border rounded-lg text-xs font-bold outline-none" value={filterMember} onChange={e=>setFilterMember(e.target.value)}>
                                <option value="ì „ì²´">ì „ì²´ íŒ€ì›</option>
                                {teamMembers.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                            <input className="p-2 border rounded text-xs outline-none" placeholder="ê³ ê°ëª…" value={search.name} onChange={e=>setSearch({...search, name:e.target.value})} />
                            <input className="p-2 border rounded text-xs outline-none" placeholder="ì—°ë½ì²˜" value={search.phone} onChange={e=>setSearch({...search, phone:e.target.value})} />
                            <input className="p-2 border rounded text-xs outline-none" placeholder="ìƒíƒœ" value={search.status} onChange={e=>setSearch({...search, status:e.target.value})} />
                        </div>
                    </div>

                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 text-slate-500 border-b">
                                <tr>
                                    <th className="p-4">íŒ€ì›</th>
                                    <th className="p-4">ê³ ê°ëª…</th>
                                    <th className="p-4">ì¢…ë¥˜</th>
                                    <th className="p-4">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y text-slate-700">
                                {filteredDBs.map(db => (
                                    <tr key={db.id} className="hover:bg-slate-50 cursor-pointer" onClick={()=>setSelectedDB(db)}>
                                        <td className="p-4 text-emerald-600">{db.partnerName}</td>
                                        <td className="p-4 text-slate-800">{db.customerName}</td>
                                        <td className="p-4 text-slate-500">{db.type}</td>
                                        <td className="p-4"><span className="px-2 py-1 bg-slate-100 rounded text-[10px]">{db.status}</span></td>
                                    </tr>
                                ))}
                                {filteredDBs.length === 0 && <tr><td colSpan="4" className="p-10 text-center text-slate-300 italic">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {selectedDB && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-6">
                                <h3 className="font-black text-slate-800 mb-4 flex justify-between">
                                    <span>ìƒì„¸ ì •ë³´ (Read Only)</span>
                                    <button onClick={()=>setSelectedDB(null)}><X size={18} className="text-slate-400"/></button>
                                </h3>
                                <div className="space-y-2 text-sm text-slate-600">
                                    <p><strong>DB Code:</strong> {selectedDB.id}</p>
                                    <p><strong>ë‹´ë‹¹ì:</strong> {selectedDB.partnerName}</p>
                                    <p><strong>ê³ ê°ëª…:</strong> {selectedDB.customerName}</p>
                                    <p><strong>ì—°ë½ì²˜:</strong> {selectedDB.phone}</p>
                                    <p><strong>ë©”ëª¨:</strong> {selectedDB.memos || 'ì—†ìŒ'}</p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 6. DB ë°˜í’ˆ (ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸°)
        const DBReturnView = ({ dbInventory, returnRequests, onRequestReturn }) => {
            const [form, setForm] = React.useState({ type: 'ë³´ì¥ë¶„ì„', dbCode: '', customerName: '', contact: '', reason: '' });
            const [selectedReturn, setSelectedReturn] = React.useState(null);
            
            const handleSubmit = () => {
                if(!form.dbCode || !form.reason || !form.customerName) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                onRequestReturn(form);
                setForm({ type: 'ë³´ì¥ë¶„ì„', dbCode: '', customerName: '', contact: '', reason: '' });
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2"><RotateCcw size={20}/> ë°˜í’ˆ ì‹ ì²­</h3>
                        <div className="space-y-3">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase">DB ì¢…ë¥˜</label>
                                <select className="w-full p-3 border rounded-lg text-sm font-bold mt-1 bg-white outline-none" value={form.type} onChange={e=>setForm({...form, type:e.target.value})}>
                                    <option>ë³´ì¥ë¶„ì„</option>
                                    <option>ìš´ì „ìë³´í—˜</option>
                                    <option>ì¬ê°€ë³´í—˜</option>
                                    <option>í«ë³´í—˜</option>
                                    <option>ë²•ì¸ì»¨ì„¤íŒ…</option>
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] font-black text-slate-400 uppercase">DB ê³ ìœ ì½”ë“œ</label>
                                    <input className="w-full p-3 border rounded-lg text-sm font-bold mt-1 outline-none" placeholder="DB-XXXX" value={form.dbCode} onChange={e=>setForm({...form, dbCode:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-[10px] font-black text-slate-400 uppercase">ê³ ê°ëª…</label>
                                    <input className="w-full p-3 border rounded-lg text-sm font-bold mt-1 outline-none" placeholder="ì´ë¦„ ì…ë ¥" value={form.customerName} onChange={e=>setForm({...form, customerName:e.target.value})}/>
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase">ì—°ë½ì²˜</label>
                                <input className="w-full p-3 border rounded-lg text-sm font-bold mt-1 outline-none" placeholder="010-XXXX-XXXX" value={form.contact} onChange={e=>setForm({...form, contact:e.target.value})}/>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase">ë°˜í’ˆ ì‚¬ìœ </label>
                                <textarea className="w-full p-3 border rounded-lg text-sm font-bold mt-1 h-24 outline-none" placeholder="ì‚¬ìœ ë¥¼ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”." value={form.reason} onChange={e=>setForm({...form, reason:e.target.value})}></textarea>
                            </div>
                            <button onClick={handleSubmit} className="w-full py-3 bg-rose-500 text-white rounded-lg font-black text-sm hover:bg-rose-600 transition-colors">ì‹ ì²­í•˜ê¸°</button>
                        </div>
                    </div>

                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <div className="p-4 border-b bg-slate-50 font-black text-xs text-slate-500 uppercase">ì‹ ì²­ ë‚´ì—­</div>
                        <div className="divide-y text-slate-700">
                            {returnRequests.map((req, i) => (
                                <div key={i} className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50" onClick={()=>setSelectedReturn(req)}>
                                    <div>
                                        <p className="text-sm font-bold text-slate-800">{req.customerName} <span className="text-xs text-slate-400 font-normal">({req.dbCode})</span></p>
                                        <p className="text-xs text-slate-500 truncate max-w-[200px]">{req.reason}</p>
                                    </div>
                                    <span className={`px-2 py-1 rounded text-[10px] font-bold ${req.status==='ìŠ¹ì¸'?'bg-emerald-100 text-emerald-600':req.status==='ë°˜ë ¤'?'bg-rose-100 text-rose-600':'bg-amber-100 text-amber-600'}`}>{req.status}</span>
                                </div>
                            ))}
                            {returnRequests.length === 0 && <div className="p-10 text-center text-xs text-slate-300 italic">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* ë°˜í’ˆ ìƒì„¸ ëª¨ë‹¬ */}
                    {selectedReturn && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6">
                                <h3 className="font-black text-lg mb-4 flex justify-between items-center">
                                    ë°˜í’ˆ ì‹ ì²­ ìƒì„¸
                                    <button onClick={()=>setSelectedReturn(null)}><X size={20} className="text-slate-400"/></button>
                                </h3>
                                <div className="space-y-3 text-sm text-slate-700">
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ì¢…ë¥˜</span> <span>{selectedReturn.type}</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ì½”ë“œ</span> <span>{selectedReturn.dbCode}</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ê³ ê°ëª…</span> <span>{selectedReturn.customerName}</span></div>
                                    <div className="flex justify-between border-b pb-2"><span className="text-slate-500 font-bold">ì—°ë½ì²˜</span> <span>{selectedReturn.contact || '-'}</span></div>
                                    <div>
                                        <span className="text-slate-500 font-bold block mb-1">ë°˜í’ˆ ì‚¬ìœ </span>
                                        <div className="bg-slate-50 p-2 rounded text-xs">{selectedReturn.reason}</div>
                                    </div>
                                    <div className="flex justify-between items-center pt-2">
                                        <span className="text-slate-500 font-bold">ì²˜ë¦¬ ìƒíƒœ</span>
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${selectedReturn.status==='ìŠ¹ì¸'?'bg-emerald-100 text-emerald-600':selectedReturn.status==='ë°˜ë ¤'?'bg-rose-100 text-rose-600':'bg-amber-100 text-amber-600'}`}>{selectedReturn.status}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 7. ê²°ì œ ê´€ë¦¬ (ì›”ë³„ í†µê³„ ì¶”ê°€)
        const PaymentManageView = ({ applyHistory, dbTypes }) => {
            const [filterType, setFilterType] = React.useState('ì „ì²´');
            const [selectedPayment, setSelectedPayment] = React.useState(null);
            const [method, setMethod] = React.useState('ì¹´ë“œê²°ì œ');
            const [memo, setMemo] = React.useState('');
            // ì›” ì„ íƒ state
            const [targetMonth, setTargetMonth] = React.useState(new Date().toISOString().slice(0, 7));

            const changeMonth = (offset) => {
                const d = new Date(targetMonth + "-01");
                d.setMonth(d.getMonth() + offset);
                setTargetMonth(d.toISOString().slice(0, 7));
            };

            const filteredHistory = applyHistory.filter(h => {
                const dateMatch = h.date && h.date.startsWith(targetMonth);
                const typeMatch = filterType === 'ì „ì²´' || h.type === filterType;
                return typeMatch; // ë¦¬ìŠ¤íŠ¸ëŠ” ì „ì²´ ë³´ì—¬ì£¼ë˜, ì›”ë³„ í†µê³„ëŠ” ì•„ë˜ì—ì„œ ë³„ë„ ê³„ì‚°
            });
            
            // ì›”ë³„ í†µê³„ ê³„ì‚°
            const monthData = applyHistory.filter(h => h.date && h.date.startsWith(targetMonth));
            const totalBuy = monthData.reduce((acc, cur) => acc + (cur.totalAmount || 0), 0);
            const totalPaid = monthData.reduce((acc, cur) => acc + (cur.paidAmount || 0), 0);
            const totalUnpaid = totalBuy - totalPaid;

            const handleConfirm = () => {
                alert(`[ê´€ë¦¬ì ì „ì†¡] ê²°ì œ í™•ì¸ ìš”ì²­\nê¸ˆì•¡: ${selectedPayment.totalAmount.toLocaleString()}ì›\në°©ë²•: ${method}`);
                setSelectedPayment(null);
            };

            return (
                <div className="space-y-6 fade-in">
                    {/* ì›”ë³„ í†µê³„ ì¹´ë“œ */}
                    <div className="bg-slate-900 p-5 rounded-xl text-white shadow-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-black flex items-center gap-2"><Wallet size={18}/> ì›”ë³„ ê²°ì œ í˜„í™©</h3>
                            <div className="flex items-center gap-3 bg-slate-800 p-1 rounded-lg">
                                <button onClick={()=>changeMonth(-1)} className="p-1 hover:text-blue-400"><ChevronLeft size={16}/></button>
                                <span className="text-sm font-bold">{targetMonth}</span>
                                <button onClick={()=>changeMonth(1)} className="p-1 hover:text-blue-400"><ChevronRight size={16}/></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4 text-center">
                            <div className="bg-slate-800 p-3 rounded-lg">
                                <p className="text-[10px] text-slate-400 mb-1">ì´ êµ¬ì… ê¸ˆì•¡</p>
                                <p className="font-bold text-lg">{totalBuy.toLocaleString()}</p>
                            </div>
                            <div className="bg-slate-800 p-3 rounded-lg">
                                <p className="text-[10px] text-slate-400 mb-1">ê²°ì œ ì™„ë£Œ</p>
                                <p className="font-bold text-lg text-emerald-400">{totalPaid.toLocaleString()}</p>
                            </div>
                            <div className="bg-slate-800 p-3 rounded-lg">
                                <p className="text-[10px] text-slate-400 mb-1">ë¯¸ë‚© ê¸ˆì•¡</p>
                                <p className="font-bold text-lg text-rose-400">{totalUnpaid.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                        <span className="text-xs font-black text-slate-500">ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸</span>
                        <select className="p-2 border rounded-lg text-xs font-bold outline-none" value={filterType} onChange={e=>setFilterType(e.target.value)}>
                            <option value="ì „ì²´">ì „ì²´ ë³´ê¸°</option>
                            {dbTypes.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                        </select>
                    </div>

                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 text-slate-500 border-b">
                                <tr>
                                    <th className="p-4">ë‚ ì§œ</th>
                                    <th className="p-4">ë‚´ìš©</th>
                                    <th className="p-4 text-right">ê¸ˆì•¡</th>
                                    <th className="p-4 text-center">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y text-slate-700">
                                {filteredHistory.map((item, i) => (
                                    <tr key={i} className="hover:bg-slate-50 cursor-pointer" onClick={()=>setSelectedPayment(item)}>
                                        <td className="p-4 font-mono text-slate-400">{item.date}</td>
                                        <td className="p-4">{item.type} ({item.qty}ê°œ)</td>
                                        <td className="p-4 text-right">{(item.totalAmount || 0).toLocaleString()}</td>
                                        <td className="p-4 text-center"><span className={`px-2 py-1 rounded text-[10px] ${item.paymentStatus==='ê²°ì œì™„ë£Œ'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-500'}`}>{item.paymentStatus || 'ë¯¸ë‚©'}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* ê²°ì œ ìƒì„¸/ì…ë ¥ ëª¨ë‹¬ */}
                    {selectedPayment && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6">
                                <h3 className="font-black text-lg mb-4 flex justify-between items-center">
                                    ê²°ì œ ì²˜ë¦¬
                                    <button onClick={()=>setSelectedPayment(null)}><X size={20} className="text-slate-400"/></button>
                                </h3>
                                <div className="space-y-4 text-sm">
                                    <div className="bg-slate-50 p-3 rounded border">
                                        <div className="flex justify-between mb-1"><span className="text-slate-500">ê²°ì œí•  ê¸ˆì•¡</span><span className="font-bold text-lg">{(selectedPayment.totalAmount || 0).toLocaleString()}ì›</span></div>
                                        <div className="flex justify-between"><span className="text-slate-500">ê¸°ë‚©ë¶€ ê¸ˆì•¡</span><span className="font-bold text-emerald-600">{(selectedPayment.paidAmount || 0).toLocaleString()}ì›</span></div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 block mb-1">ê²°ì œ ë°©ë²• ì„ íƒ</label>
                                        <select className="w-full p-2 border rounded font-bold" value={method} onChange={e=>setMethod(e.target.value)}>
                                            <option>ì¹´ë“œê²°ì œ</option>
                                            <option>ê³„ì¢Œì´ì²´</option>
                                            <option>ê¸°íƒ€ (ë©”ëª¨)</option>
                                        </select>
                                    </div>

                                    {method === 'ê³„ì¢Œì´ì²´' && (
                                        <div className="bg-blue-50 p-3 rounded border border-blue-100 text-xs text-blue-700">
                                            <p className="font-black mb-1">ì…ê¸ˆ ê³„ì¢Œ ì •ë³´</p>
                                            <p>í•˜ë‚˜ì€í–‰ 000-111-1111-222</p>
                                            <p>(ì£¼)íŒŒíŠ¸ë„ˆìŠ¤ì»´í¼ë‹ˆ</p>
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 block mb-1">ë©”ëª¨ (ì„ íƒ)</label>
                                        <textarea className="w-full p-2 border rounded text-xs h-16 outline-none" placeholder="ì…ê¸ˆìëª… ë“± íŠ¹ì´ì‚¬í•­" value={memo} onChange={e=>setMemo(e.target.value)}></textarea>
                                    </div>

                                    <button onClick={handleConfirm} className="w-full py-3 bg-slate-900 text-white rounded-lg font-black mt-2">ê²°ì œ í™•ì¸ ìš”ì²­ (ê´€ë¦¬ì ì „ì†¡)</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 8. ë§ˆì´í˜ì´ì§€
        const MyPageView = ({ user, onUpdateUser }) => {
            const [info, setInfo] = React.useState({ ...user, password: '' });

            const handleSave = () => {
                onUpdateUser(info);
                alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm text-center">
                        <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center text-4xl mx-auto mb-4">ğŸ‘¤</div>
                        <h2 className="text-xl font-black text-slate-800">{user.name}</h2>
                        <p className="text-sm text-slate-500">{user.role === 'BRANCH_MANAGER' ? 'ì§€ì ì¥' : 'ì˜ì—…ì'} | {user.team}</p>
                    </div>

                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-4">
                        <h3 className="font-black text-slate-800 flex items-center gap-2"><Settings size={18}/> ì •ë³´ ìˆ˜ì •</h3>
                        <div className="space-y-3">
                            <div><label className="text-[10px] text-slate-400 font-black">ì´ë¦„</label><input className="w-full p-3 border rounded-lg text-sm mt-1" value={info.name} onChange={e=>setInfo({...info, name:e.target.value})} /></div>
                            <div><label className="text-[10px] text-slate-400 font-black">ì—°ë½ì²˜</label><input className="w-full p-3 border rounded-lg text-sm mt-1" placeholder="010-0000-0000" value={info.phone || ''} onChange={e=>setInfo({...info, phone:e.target.value})} /></div>
                            <div><label className="text-[10px] text-slate-400 font-black">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input className="w-full p-3 border rounded-lg text-sm mt-1" type="password" placeholder="ë³€ê²½í•  ê²½ìš° ì…ë ¥" value={info.password} onChange={e=>setInfo({...info, password:e.target.value})} /></div>
                            <button onClick={handleSave} className="w-full py-3 bg-slate-900 text-white rounded-lg font-black text-sm mt-2">ì €ì¥í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- [Main App] ---
        const UserApp = () => {
            const [view, setView] = React.useState('login');
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [currentUser, setCurrentUser] = React.useState(null);
            const [loading, setLoading] = React.useState(false);

            // Data States
            const [dbInventory, setDbInventory] = React.useState([]); 
            const [applyHistory, setApplyHistory] = React.useState([]); // ì‹ ì²­ ë‚´ì—­
            const [teamDBs, setTeamDBs] = React.useState([]); // íŒ€ì› DB
            const [returnRequests, setReturnRequests] = React.useState([]); // ë°˜í’ˆ ë‚´ì—­
            
            // ê´€ë¦¬ì ì„¤ì • ë°ì´í„° (ê°€ì •)
            const dbTypes = [
                { code: 'bo', name: 'ë³´ì¥ë¶„ì„', price: 50000, promotion: 'ì‹ ê·œ 10% ì¶”ê°€ ì§€ê¸‰' },
                { code: 'un', name: 'ìš´ì „ìë³´í—˜', price: 30000, promotion: '30ê°œ ì‹ ì²­ ì‹œ 5ê°œ ë¬´ë£Œ' },
                { code: 'ja', name: 'ì¬ê°€ë³´í—˜', price: 40000, promotion: '' },
                { code: 'pt', name: 'í«ë³´í—˜', price: 45000, promotion: '' },
                { code: 'co', name: 'ë²•ì¸ì»¨ì„¤íŒ…', price: 100000, promotion: 'ì²« ê±°ë˜ 50% í• ì¸' }
            ];

            const callApi = React.useCallback(async (action, payload = {}) => {
                if(!API_URL) return { status: 'error', error: 'URL Missing' };
                try {
                    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
                    return await res.json();
                } catch(e) { return { status: 'error' }; }
            }, []);

            const refreshData = React.useCallback(async () => {
                if(!API_URL) {
                    if(currentUser) {
                        // Mock Data
                        setDbInventory([
                            { id: 'DB-001', customerName: 'ê¹€ì² ìˆ˜', type: 'ë³´ì¥ë¶„ì„', status: 'ë¯¸íŒ… í™•ì •', date: '2024-01-15', phone: '010-1234-5678', area: 'ì„œìš¸', gender: 'ë‚¨', etc1: '30ëŒ€', etc3: 'ê°€ë§ê³ ê°', memos: '' },
                            { id: 'DB-002', customerName: 'ì´ì˜í¬', type: 'ìš´ì „ìë³´í—˜', status: 'ì™„ë£Œ', date: '2024-01-10', phone: '010-9876-5432', area: 'ê²½ê¸°', gender: 'ì—¬', etc1: '40ëŒ€', memos: 'ê°€ì…ì™„ë£Œ' }
                        ]);
                        // ì‹ ì²­ ë‚´ì—­ì— ê²°ì œ ì •ë³´ í¬í•¨ (ë‚ ì§œ í¬ë§· í†µì¼)
                        setApplyHistory([
                            { type: 'ë³´ì¥ë¶„ì„', qty: 10, date: '2024-01-15', totalAmount: 500000, paidAmount: 0, paymentStatus: 'ê²°ì œì „' },
                            { type: 'ìš´ì „ìë³´í—˜', qty: 5, date: '2024-01-10', totalAmount: 150000, paidAmount: 150000, paymentStatus: 'ê²°ì œì™„ë£Œ', method: 'ì¹´ë“œê²°ì œ' }
                        ]);
                        if(currentUser.role === 'BRANCH_MANAGER') {
                            setTeamDBs([
                                { id: 'T-001', partnerName: 'ê¹€íŒ€ì›', customerName: 'ë°•ê³ ê°', type: 'í«ë³´í—˜', status: 'ë¶€ì¬', phone:'010-1111-2222', memos:'' },
                                { id: 'T-002', partnerName: 'ì´íŒ€ì›', customerName: 'ìµœê³ ê°', type: 'ë³´ì¥ë¶„ì„', status: 'ì—°ë½ì „', phone:'010-3333-4444', memos:'ë¶€ì¬ì¤‘' }
                            ]);
                        }
                    }
                    return;
                }
                // API Load Logic (To be implemented)
            }, [currentUser]);

            React.useEffect(() => { if(view === 'dashboard') refreshData(); }, [view, refreshData]);

            const handleLogin = async (id, pw) => {
                setLoading(true);
                await new Promise(r=>setTimeout(r, 500));
                
                if (id === 'test' && pw === 'test') {
                    setCurrentUser({ employeeId: 'test', name: 'ê¹€ì˜ì—…', team: 'ì˜ì—…1íŒ€', role: 'SALES' });
                    setView('dashboard');
                } else if (id === 'manager' && pw === 'manager') {
                    setCurrentUser({ employeeId: 'manager', name: 'ë°•ì§€ì ì¥', team: 'ì˜ì—…1íŒ€', role: 'BRANCH_MANAGER' });
                    setView('dashboard');
                } else {
                    alert("ë¡œê·¸ì¸ ì •ë³´ í™•ì¸ í•„ìš”");
                }
                setLoading(false);
            };

            const handleLogout = () => { setCurrentUser(null); setView('login'); };

            const handleApply = (form) => {
                // ì‹ ì²­ ë¡œê·¸ ì¶”ê°€ (ë‚ ì§œ í¬ë§· YYYY-MM-DD)
                const today = new Date().toISOString().slice(0,10);
                const newLog = { 
                    ...form, 
                    date: today, 
                    paymentStatus: 'ê²°ì œì „', 
                    paidAmount: 0 
                };
                setApplyHistory(prev => [newLog, ...prev]);
            };

            const handleSaveMemo = (id, memo) => {
                setDbInventory(prev => prev.map(d => d.id === id ? { ...d, memos: memo } : d));
            };
            
            const handleUpdateStatus = (id, status) => {
                setDbInventory(prev => prev.map(d => d.id === id ? { ...d, status: status } : d));
            };

            const handleReturnRequest = (req) => {
                setReturnRequests(prev => [...prev, { ...req, status: 'ê²€í† ì¤‘' }]);
                alert("ë°˜í’ˆ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleUpdateUser = (info) => {
                setCurrentUser({ ...currentUser, ...info });
            };

            return (
                <div className="min-h-screen bg-[#F8FAFC] flex font-sans text-slate-900">
                    {view === 'login' ? (
                        <LoginView onLogin={handleLogin} loading={loading}/>
                    ) : (
                        <div className="flex-1 flex flex-col max-w-md mx-auto bg-white min-h-screen shadow-2xl relative">
                            <header className="h-16 border-b border-slate-100 flex items-center justify-between px-6 bg-white sticky top-0 z-10">
                                <div>
                                    <p className="text-[10px] font-black text-blue-600 uppercase tracking-widest">Meta v5.96</p>
                                    <h1 className="font-black italic text-lg uppercase text-slate-800">{activeTab}</h1>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="text-xs font-bold bg-slate-50 text-slate-600 px-3 py-1 rounded-full flex items-center gap-1 border border-slate-100">
                                        <User size={12}/> {currentUser.name}
                                    </span>
                                    <button onClick={()=>setActiveTab('mypage')} className="text-slate-400 hover:text-blue-600"><Settings size={18}/></button>
                                    <button onClick={handleLogout} className="text-slate-400 hover:text-rose-500"><LogOut size={18}/></button>
                                </div>
                            </header>

                            <div className="flex-1 p-6 overflow-y-auto pb-24 bg-[#F8FAFC]">
                                {activeTab === 'dashboard' && <MainDashboard dbInventory={dbInventory} applyHistory={applyHistory}/>}
                                {activeTab === 'manage' && <DBManageView dbInventory={dbInventory} applyHistory={applyHistory} onSaveMemo={handleSaveMemo} onUpdateStatus={handleUpdateStatus} dbTypes={dbTypes}/>}
                                {activeTab === 'apply' && <DBApplyView onApply={handleApply} loading={loading} applyHistory={applyHistory} dbTypes={dbTypes}/>}
                                {activeTab === 'team' && <TeamManageView teamDBs={teamDBs}/>}
                                {activeTab === 'return' && <DBReturnView dbInventory={dbInventory} returnRequests={returnRequests} onRequestReturn={handleReturnRequest}/>}
                                {activeTab === 'payment' && <PaymentManageView applyHistory={applyHistory} dbTypes={dbTypes}/>}
                                {activeTab === 'mypage' && <MyPageView user={currentUser} onUpdateUser={handleUpdateUser}/>}
                            </div>

                            <nav className="h-20 border-t border-slate-100 flex justify-around items-center text-[10px] font-black text-slate-400 bg-white fixed bottom-0 w-full max-w-md z-20 overflow-x-auto px-2">
                                <button onClick={()=>setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 min-w-[50px] ${activeTab==='dashboard'?'text-blue-600':''}`}><LayoutDashboard size={20}/>í™ˆ</button>
                                <button onClick={()=>setActiveTab('apply')} className={`flex flex-col items-center gap-1 min-w-[50px] ${activeTab==='apply'?'text-blue-600':''}`}><Send size={20}/>ì‹ ì²­</button>
                                <button onClick={()=>setActiveTab('manage')} className={`flex flex-col items-center gap-1 min-w-[50px] ${activeTab==='manage'?'text-blue-600':''}`}><Database size={20}/>DBê´€ë¦¬</button>
                                <button onClick={()=>setActiveTab('payment')} className={`flex flex-col items-center gap-1 min-w-[50px] ${activeTab==='payment'?'text-blue-600':''}`}><Wallet size={20}/>ê²°ì œ</button>
                                {currentUser.role === 'BRANCH_MANAGER' && (
                                    <button onClick={()=>setActiveTab('team')} className={`flex flex-col items-center gap-1 min-w-[50px] ${activeTab==='team'?'text-blue-600':''}`}><Users2 size={20}/>íŒ€ê´€ë¦¬</button>
                                )}
                                <button onClick={()=>setActiveTab('return')} className={`flex flex-col items-center gap-1 min-w-[50px] ${activeTab==='return'?'text-blue-600':''}`}><RotateCcw size={20}/>ë°˜í’ˆ</button>
                            </nav>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UserApp />);
    </script>
</body>
</html>
